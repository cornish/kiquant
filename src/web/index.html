<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kiQuant</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <div id="toolbar">
            <!-- File Menu Dropdown -->
            <div class="toolbar-group dropdown-group">
                <button id="btn-file" class="toolbar-btn dropdown-trigger" title="File Menu">File</button>
                <div id="file-menu" class="dropdown-menu hidden">
                    <div class="dropdown-item" data-action="new">New Project</div>
                    <div class="dropdown-item" data-action="load">Load Project</div>
                    <div class="dropdown-item" data-action="quick">Quick Mode</div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" data-action="save">Save Project</div>
                    <div class="dropdown-item" data-action="export">Export CSV</div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" data-action="about">About kiQuant</div>
                </div>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button id="btn-undo" class="toolbar-btn" title="Undo (Ctrl+Z)" disabled>Undo</button>
                <button id="btn-redo" class="toolbar-btn" title="Redo (Ctrl+Y)" disabled>Redo</button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group mode-buttons">
                <button id="btn-positive" class="mode-btn active" data-mode="0" title="Positive Marker (P)">
                    <span class="marker-icon positive">+</span> Positive
                </button>
                <button id="btn-negative" class="mode-btn" data-mode="1" title="Negative Marker (N)">
                    <span class="marker-icon negative">-</span> Negative
                </button>
                <div class="mode-btn-group">
                    <button id="btn-select" class="mode-btn" data-mode="2" title="Select Mode (S)">
                        Select
                    </button>
                    <button id="btn-select-dropdown" class="mode-btn-dropdown" title="Selection Type">â–¾</button>
                    <div id="select-menu" class="dropdown-menu select-dropdown hidden">
                        <div class="dropdown-item" data-select-type="rect">Rectangle Select</div>
                        <div class="dropdown-item" data-select-type="lasso">Lasso Select</div>
                    </div>
                </div>
                <button id="btn-eraser" class="mode-btn" data-mode="3" title="Eraser Mode (E)">
                    Eraser
                </button>
                <button id="btn-pan" class="mode-btn" data-mode="4" title="Pan Mode (H)">
                    Pan
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <!-- Detection Controls -->
            <div class="toolbar-group detection-group" id="detection-group">
                <select id="detect-model" class="toolbar-select" title="Detection Model">
                    <option value="" disabled selected>No AI models</option>
                </select>
                <select id="detect-classify" class="toolbar-select" title="Classification Mode">
                    <option value="auto">Auto (DAB)</option>
                    <option value="all_positive">All Positive</option>
                    <option value="all_negative">All Negative</option>
                </select>
                <div id="threshold-container" class="threshold-container">
                    <input type="range" id="dab-threshold" class="threshold-slider" min="0" max="100" value="30" title="DAB Threshold">
                    <span id="threshold-value" class="threshold-value">30%</span>
                </div>
                <button id="btn-detect" class="detect-btn" title="Run Detection (D)" disabled>Detect</button>
                <button id="btn-detect-settings" class="detect-settings-btn" title="Detection Settings" disabled>&#9881;</button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group nav-group">
                <button id="btn-prev" class="nav-btn" title="Previous Image (Left Arrow)">&lt;</button>
                <span id="progress">0 / 0</span>
                <button id="btn-next" class="nav-btn" title="Next Image (Right Arrow)">&gt;</button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group counts">
                <span class="count positive-count">Pos: <span id="count-positive">0</span></span>
                <span class="count negative-count">Neg: <span id="count-negative">0</span></span>
                <span class="count total-count">Total: <span id="count-total">0</span></span>
                <span class="count pi-count">PI: <span id="count-pi">-</span></span>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div id="canvas-container">
            <div id="welcome-message">
                <h2>kiQuant</h2>
                <p>Cell marker quantification tool</p>
                <div class="welcome-buttons">
                    <button id="welcome-new" class="welcome-btn">New Project</button>
                    <button id="welcome-load" class="welcome-btn">Load Project</button>
                    <button id="welcome-quick" class="welcome-btn welcome-btn-secondary">Quick Mode</button>
                </div>
            </div>
            <div id="canvas-viewport">
                <canvas id="canvas"></canvas>
                <canvas id="overlay-canvas"></canvas>
            </div>

            <!-- Overview Map -->
            <div id="overview-panel" class="hidden">
                <canvas id="overview-canvas"></canvas>
                <div id="overview-viewport"></div>
            </div>

            <!-- Zoom Controls -->
            <div id="zoom-controls" class="hidden">
                <button id="btn-zoom-in" class="zoom-btn" title="Zoom In (+)">+</button>
                <span id="zoom-level">100%</span>
                <button id="btn-zoom-out" class="zoom-btn" title="Zoom Out (-)">-</button>
                <button id="btn-zoom-fit" class="zoom-btn zoom-btn-text" title="Fit to Window (F)">Fit</button>
                <button id="btn-zoom-100" class="zoom-btn zoom-btn-text" title="Actual Size (1)">1:1</button>
                <span class="zoom-separator">|</span>
                <button id="btn-toggle-guide" class="zoom-btn zoom-btn-text" title="Toggle Field Guide (G)">Guide</button>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="context-menu" class="context-menu hidden">
            <div class="context-menu-item" data-action="mode-positive"><span class="menu-icon positive">+</span> Positive Mode</div>
            <div class="context-menu-item" data-action="mode-negative"><span class="menu-icon negative">-</span> Negative Mode</div>
            <div class="context-menu-item" data-action="mode-pan"><span class="menu-icon pan">&#9995;</span> Pan Mode</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" data-action="select-all">Select All</div>
            <div class="context-menu-item" data-action="deselect-all">Deselect All</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" data-action="change-positive">Change to Positive</div>
            <div class="context-menu-item" data-action="change-negative">Change to Negative</div>
            <div class="context-menu-item" data-action="delete-selected">Delete Selected</div>
        </div>

        <!-- About Modal -->
        <div id="about-modal" class="modal hidden">
            <div class="modal-content">
                <div class="about-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" width="80" height="80">
                        <ellipse cx="75" cy="75" rx="65" ry="55" fill="#4a5a8a" stroke="#2d3a5c" stroke-width="4"/>
                        <ellipse cx="68" cy="68" rx="50" ry="40" fill="#5d6fa3" opacity="0.6"/>
                        <ellipse cx="130" cy="190" rx="70" ry="55" fill="#4a5a8a" stroke="#2d3a5c" stroke-width="4"/>
                        <ellipse cx="122" cy="182" rx="54" ry="42" fill="#5d6fa3" opacity="0.6"/>
                        <ellipse cx="190" cy="105" rx="60" ry="52" fill="#8b6914" stroke="#5c4610" stroke-width="4"/>
                        <ellipse cx="183" cy="98" rx="46" ry="40" fill="#a67c1a" opacity="0.6"/>
                        <g stroke="#ef4444" stroke-width="10" stroke-linecap="round">
                            <line x1="75" y1="50" x2="75" y2="100"/><line x1="50" y1="75" x2="100" y2="75"/>
                        </g>
                        <g stroke="#22c55e" stroke-width="10" stroke-linecap="round">
                            <line x1="190" y1="80" x2="190" y2="130"/><line x1="165" y1="105" x2="215" y2="105"/>
                        </g>
                        <g stroke="#ef4444" stroke-width="10" stroke-linecap="round">
                            <line x1="130" y1="165" x2="130" y2="215"/><line x1="105" y1="190" x2="155" y2="190"/>
                        </g>
                    </svg>
                </div>
                <h2>kiQuant</h2>
                <p id="about-version"></p>
                <p>Cell marker quantification tool for<br>immunohistochemistry analysis.</p>
                <p class="about-copyright"></p>
                <p><a href="#" id="about-link">github.com/cornish/kiquant</a></p>
                <button id="about-close" class="modal-close">OK</button>
            </div>
        </div>

        <!-- Detection Settings Modal -->
        <div id="detection-settings-modal" class="modal hidden">
            <div class="modal-content settings-modal">
                <h2>Detection Settings</h2>

                <div class="settings-section" id="cellpose-settings">
                    <h3>CellPose Settings</h3>
                    <div class="setting-row">
                        <label for="setting-diameter">Nucleus Diameter (pixels)</label>
                        <input type="number" id="setting-diameter" min="0" max="200" value="0" step="1">
                        <span class="setting-hint">0 = auto-detect</span>
                    </div>
                    <div class="setting-row">
                        <label for="setting-cellprob">Cell Probability Threshold</label>
                        <input type="range" id="setting-cellprob" min="-6" max="6" value="0" step="0.5">
                        <span id="setting-cellprob-value" class="setting-value">0.0</span>
                        <span class="setting-hint">Lower = more cells detected</span>
                    </div>
                    <div class="setting-row">
                        <label for="setting-flow">Flow Threshold</label>
                        <input type="range" id="setting-flow" min="0" max="1" value="0.4" step="0.05">
                        <span id="setting-flow-value" class="setting-value">0.4</span>
                        <span class="setting-hint">Lower = more permissive</span>
                    </div>
                </div>

                <div class="settings-section" id="stardist-settings">
                    <h3>StarDist Settings</h3>
                    <div class="setting-row">
                        <label for="setting-prob">Probability Threshold</label>
                        <input type="range" id="setting-prob" min="0.1" max="0.9" value="0.5" step="0.05">
                        <span id="setting-prob-value" class="setting-value">0.5</span>
                        <span class="setting-hint">Lower = more cells detected</span>
                    </div>
                    <div class="setting-row">
                        <label for="setting-nms">NMS Threshold</label>
                        <input type="range" id="setting-nms" min="0.1" max="0.9" value="0.3" step="0.05">
                        <span id="setting-nms-value" class="setting-value">0.3</span>
                        <span class="setting-hint">Overlap threshold</span>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button id="settings-reset" class="modal-btn-secondary">Reset Defaults</button>
                    <button id="settings-close" class="modal-close">OK</button>
                </div>
            </div>
        </div>

        <!-- Detection Progress Modal -->
        <div id="detection-progress" class="detection-progress hidden">
            <div class="detection-progress-content">
                <div class="detection-progress-spinner"></div>
                <div id="detection-progress-bar-container">
                    <div id="detection-progress-bar"></div>
                </div>
                <span id="detection-progress-text">Detecting...</span>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <span id="status-filename">No image loaded</span>
            <span id="status-mode">Mode: Positive</span>
            <span id="status-summary"></span>
        </div>
    </div>

    <script src="/eel.js"></script>
    <script src="app.js"></script>
</body>
</html>
